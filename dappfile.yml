artifact: build
from: {{ env "BUILD_IMAGE" }}
git:
    - add: /
      to: /build
      stageDependencies:
        install:
          - package.json
        beforeSetup:
          - "*"
ansible:
  install:
    - name: npm install
      npm:
        path: /build
        registry: 'https://nexus.iondv.ru/repository/npm-all/'  
  beforeSetup:
    - name: gulp and npm
      shell: |
        gulp assemble
      args:
        chdir: /build
---
dimg: ~
from: node:8.12-slim
ansible:
  setup:
    - name: startup script
      shell: |
        echo "node /var/www/www" > /opt/start.sh
        echo "node /var/www/www" > /opt/production.sh
docker:
  EXPOSE: 
    - "8888"
  ENV:
    NODE_PATH: "/var/www"
    CI_COMMIT_REF_SLUG: {{ env "CI_COMMIT_REF_SLUG" }}
  CMD: node /var/www/www
import:
  - artifact: build
    add: /build
    to: /var/www
    before: setup
